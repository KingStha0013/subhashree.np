<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopNepal - Professional E-Commerce</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* =================================================================
           1. PROFESSIONAL & ANIMATED MOBILE-FIRST CSS (FIXED & ENHANCED)
           ================================================================= */
        :root {
            --primary-color: #5E5DF0;
            --background-color: #f4f5f7;
            --surface-color: #ffffff;
            --text-color: #333;
            --subtle-text-color: #6c757d;
            --border-color: #e9ecef;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --font-family: 'Poppins', sans-serif;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-hover: 0 6px 16px rgba(0,0,0,0.12);
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { font-family: var(--font-family); background-color: var(--background-color); color: var(--text-color); line-height: 1.6; -webkit-font-smoothing: antialiased; }

        /* --- Login View --- */
        #login-view { display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        #login-box { width: 100%; max-width: 420px; padding: 3rem; background: var(--surface-color); border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); text-align: center; }
        #login-box h2 { font-size: 2rem; font-weight: 700; color: var(--primary-color); margin-bottom: 0.5rem; }
        #login-box p { color: var(--subtle-text-color); margin-bottom: 2rem; }

        /* --- Store View (Animated Entry) --- */
        #store-view { display: none; animation: fadeIn 0.8s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Layout & Structure --- */
        .container { max-width: 1280px; margin: 0 auto; padding: 0 1.5rem; }
        header { position: sticky; top: 0; left: 0; width: 100%; background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); z-index: 1000; padding: 1rem 0; }
        .navbar { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.75rem; font-weight: 700; color: var(--primary-color); text-decoration: none; }
        .desktop-nav-links { display: none; } /* Hidden on mobile */
        .header-icons { display: flex; align-items: center; gap: 1.5rem; }
        .icon-link { position: relative; font-size: 1.3rem; color: var(--subtle-text-color); text-decoration: none; cursor: pointer; transition: color 0.3s; }
        .icon-link:hover { color: var(--primary-color); }
        
        /* --- Badge System (Numbered Badge + Notification Dot) --- */
        .badge { position: absolute; top: -8px; right: -10px; background-color: var(--danger-color); color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 0.75rem; display: flex; justify-content: center; align-items: center; font-weight: 600; border: 2px solid var(--surface-color); transform: scale(0); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .badge.visible { transform: scale(1); }
        .badge-dot { position: absolute; top: -2px; right: -2px; background-color: var(--primary-color); width: 10px; height: 10px; border-radius: 50%; border: 2px solid var(--surface-color); display: none; }
        .icon-link.has-new .badge-dot { display: block; }
        
        main { padding: 1.5rem 0 80px 0; } /* Padding bottom for bottom nav */
        .page { display: none; }
        .page.active { display: block; animation: pageTransition 0.5s forwards; }
        @keyframes pageTransition {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* --- Bottom Navigation (Mobile Only) --- */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 70px; background: var(--surface-color); box-shadow: 0 -2px 10px rgba(0,0,0,0.08); display: flex; justify-content: space-around; align-items: center; z-index: 1000; border-top-left-radius: 16px; border-top-right-radius: 16px; }
        .bottom-nav-link { display: flex; flex-direction: column; align-items: center; color: var(--subtle-text-color); text-decoration: none; font-size: 0.7rem; transition: color 0.3s, transform 0.2s; position: relative; }
        .bottom-nav-link i { font-size: 1.4rem; margin-bottom: 4px; }
        .bottom-nav-link.active { color: var(--primary-color); transform: translateY(-5px); }
        .bottom-nav-link .badge { top: -5px; right: -15px; }

        /* --- Desktop Navigation --- */
        @media (min-width: 768px) {
            .bottom-nav { display: none; }
            .desktop-nav-links { display: flex; gap: 2rem; list-style: none; }
            .desktop-nav-links a { text-decoration: none; color: var(--text-color); font-weight: 500; transition: color 0.3s; position: relative; padding-bottom: 5px; }
            .desktop-nav-links a::after { content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 2px; background-color: var(--primary-color); transition: width 0.3s ease; }
            .desktop-nav-links a:hover::after, .desktop-nav-links a.active::after { width: 100%; }
            .desktop-nav-links a:hover, .desktop-nav-links a.active { color: var(--primary-color); }
            main { padding-bottom: 2.5rem; }
            #cart-page-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; align-items: flex-start; }
            #cart-summary { position: sticky; top: 100px; }
        }

        /* --- Product Grid & On-Scroll Animation (SMALLER CARDS) --- */
        .product-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
        .product-card { background-color: var(--surface-color); border-radius: 12px; box-shadow: var(--shadow); overflow: hidden; display: flex; flex-direction: column; transition: transform 0.3s, box-shadow 0.3s; opacity: 0; transform: translateY(30px); cursor: pointer; }
        .product-card.animate { animation: slideUp 0.6s forwards; }
        .product-card:hover { transform: translateY(-5px) !important; box-shadow: var(--shadow-hover); }
        @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }
        .product-card-img { width: 100%; height: 160px; object-fit: cover; }
        .product-card-body { padding: 0.8rem; flex-grow: 1; display: flex; flex-direction: column; }
        .product-card-title { font-size: 0.9rem; font-weight: 600; margin-bottom: 0.25rem; }
        .product-card-price { font-size: 1.1rem; font-weight: 700; color: var(--primary-color); margin-bottom: 0.75rem; }
        .product-card-actions { margin-top: auto; display: flex; justify-content: space-between; align-items: center; }
        .product-card-actions .btn { padding: 0.5rem 0.8rem; font-size: 0.8rem; }
        .product-card-actions .icon-btn { font-size: 1.2rem; }

        /* --- Skeleton Loader (SMALLER) --- */
        .skeleton-card { background-color: var(--surface-color); border-radius: 12px; box-shadow: var(--shadow); overflow: hidden; }
        .skeleton-img { width: 100%; height: 160px; }
        .skeleton-body { padding: 0.8rem; }
        .skeleton-text { height: 18px; margin-bottom: 8px; border-radius: 4px; }
        .shimmer { position: relative; overflow: hidden; background-color: #e0e0e0; }
        .shimmer::after { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 100% { left: 100%; } }

        /* --- Search Overlay --- */
        #search-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--background-color); z-index: 1100; transform: translateY(-100%); transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); display: flex; flex-direction: column; padding: 1.5rem; }
        #search-overlay.active { transform: translateY(0); }
        .search-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem; }
        #close-search { font-size: 1.5rem; cursor: pointer; }
        #search-input { flex-grow: 1; font-size: 1.2rem; border: none; background: none; border-bottom: 2px solid var(--border-color); padding: 0.5rem 0; outline: none; }
        #search-input:focus { border-bottom-color: var(--primary-color); }

        /* --- Profile Page --- */
        .profile-container { background: var(--surface-color); padding: 2rem; border-radius: 16px; max-width: 500px; margin: 0 auto; box-shadow: var(--shadow); }
        .profile-header { text-align: center; margin-bottom: 2rem; }
        .profile-avatar { font-size: 5rem; color: var(--primary-color); margin-bottom: 1rem; }
        #profile-email { font-size: 1.2rem; font-weight: 500; word-break: break-all; }
        .profile-actions { display: flex; flex-direction: column; gap: 1rem; }
        .profile-link { display: flex; align-items: center; padding: 1rem; background: var(--background-color); border-radius: 8px; text-decoration: none; color: var(--text-color); font-weight: 500; transition: background-color 0.3s; }
        .profile-link:hover { background-color: #e9ecef; }
        .profile-link i:first-child { margin-right: 1rem; color: var(--primary-color); width: 20px; text-align: center; }
        .profile-link span { flex-grow: 1; }
        #profile-logout-btn { width: 100%; justify-content: center; background-color: var(--danger-color); }

        /* --- Cart Page Specifics --- */
        .cart-item { background: var(--surface-color); border-radius: 12px; padding: 1rem; box-shadow: var(--shadow); display: flex; align-items: center; gap: 1rem; }
        .cart-item-img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
        .cart-item-details { flex-grow: 1; }
        .cart-item-actions { display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem; }
        .quantity-control { display: flex; align-items: center; gap: 0.75rem; }
        .quantity-btn { background: var(--border-color); color: var(--text-color); border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        .remove-item-btn { background: none; border: none; color: var(--subtle-text-color); cursor: pointer; font-size: 1.1rem; }
        #cart-summary { background: var(--surface-color); border-radius: 12px; padding: 1.5rem; box-shadow: var(--shadow); }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 1rem; }
        .summary-row span:last-child { font-weight: 600; }
        #checkout-btn { width: 100%; margin-top: 1rem; }

        /* --- General UI & Helpers --- */
        .page-header { font-size: 1.8rem; margin-bottom: 1.5rem; }
        .empty-state { text-align: center; padding: 4rem 2rem; background: var(--surface-color); border-radius: 12px; }
        .empty-state i { font-size: 4rem; color: var(--border-color); margin-bottom: 1rem; }

        /* --- Modals, Loader, Toast --- */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal.active { display: flex; animation: fadeIn 0.3s; }
        .modal-content { background-color: var(--surface-color); padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; position: relative; animation: modalZoomIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes modalZoomIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .close-btn { position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; cursor: pointer; }
        #loader { display: none; position: fixed; z-index: 4000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.7); justify-content: center; align-items: center; }
        #loader.active { display: flex; }
        .spinner { width: 50px; height: 50px; border: 5px solid var(--border-color); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 3000; }
        .toast { padding: 1rem 1.5rem; margin-bottom: 1rem; border-radius: 8px; color: white; font-weight: 500; box-shadow: var(--shadow); display: flex; align-items: center; gap: 1rem; transform: translateX(120%); animation: slideIn 0.5s forwards; }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }
        @keyframes slideIn { to { transform: translateX(0); } }
    </style>
</head>
<body>
    
    <div id="loader"><div class="spinner"></div></div>
    <div id="toast-container"></div>

    <div id="login-view">
        <div id="login-box">
            <!-- Login/Register Forms will be injected by JS -->
        </div>
    </div>

    <div id="store-view">
        <header>
            <div class="container">
                <nav class="navbar">
                    <a href="#home" class="logo">ShopNepal</a>
                    <ul class="desktop-nav-links">
                        <li><a href="#home" class="nav-link active">Home</a></li>
                        <li><a href="#orders" class="nav-link">My Orders</a></li>
                    </ul>
                    <div class="header-icons">
                        <a id="open-search" href="#" class="icon-link"><i class="fas fa-search"></i></a>
                        <a href="#wishlist" class="icon-link" id="desktop-wishlist-link"><span class="badge" id="wishlist-badge-desktop">0</span><span class="badge-dot"></span><i class="fas fa-heart"></i></a>
                        <a href="#cart" class="icon-link" id="desktop-cart-link"><span class="badge" id="cart-badge-desktop">0</span><span class="badge-dot"></span><i class="fas fa-shopping-cart"></i></a>
                        <a href="#profile" class="icon-link"><i class="fas fa-user-circle"></i></a>
                    </div>
                </nav>
            </div>
        </header>

        <main class="container">
            <div id="home-page" class="page"><div id="product-grid" class="product-grid"></div></div>
            <div id="wishlist-page" class="page"><h2 class="page-header">My Wishlist</h2><div id="wishlist-items" class="item-list"></div></div>
            <div id="cart-page" class="page">
                <h2 class="page-header">My Cart</h2>
                <div id="cart-page-layout">
                    <div id="cart-items" class="item-list"></div>
                    <div id="cart-summary"></div>
                </div>
            </div>
            <div id="orders-page" class="page"><h2 class="page-header">My Orders</h2><div id="orders-list" class="item-list"></div></div>
            <div id="profile-page" class="page">
                <h2 class="page-header">My Profile</h2>
                <div class="profile-container">
                    <div class="profile-header">
                        <i class="fas fa-user-circle profile-avatar"></i>
                        <p id="profile-email">loading...</p>
                    </div>
                    <div class="profile-actions">
                        <a href="#orders" class="profile-link">
                            <i class="fas fa-receipt fa-fw"></i>
                            <span>My Orders</span>
                            <i class="fas fa-chevron-right"></i>
                        </a>
                        <button id="profile-logout-btn" class="btn btn-danger">
                            <i class="fas fa-sign-out-alt fa-fw"></i>
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <nav class="bottom-nav">
            <a href="#home" class="bottom-nav-link active"><i class="fas fa-home"></i><span>Home</span></a>
            <a href="#wishlist" class="bottom-nav-link" id="mobile-wishlist-link"><span class="badge" id="wishlist-badge-mobile">0</span><span class="badge-dot"></span><i class="fas fa-heart"></i><span>Wishlist</span></a>
            <a href="#cart" class="bottom-nav-link" id="mobile-cart-link"><span class="badge" id="cart-badge-mobile">0</span><span class="badge-dot"></span><i class="fas fa-shopping-cart"></i><span>Cart</span></a>
            <a href="#profile" class="bottom-nav-link"><i class="fas fa-user-circle"></i><span>Profile</span></a>
        </nav>
    </div>

    <div id="search-overlay">
        <div class="search-header">
            <i id="close-search" class="fas fa-arrow-left"></i>
            <input type="text" id="search-input" placeholder="Search for products..." autocomplete="off">
        </div>
        <div id="search-results-grid" class="product-grid"></div>
    </div>

    <div id="product-detail-modal" class="modal"></div>
    <div id="payment-modal" class="modal"></div>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script type="module">
        // =================================================================
        // 4. PROFESSIONAL MOBILE-FIRST JAVASCRIPT (FIXED & ENHANCED)
        // =================================================================

        // =================================================================
        // ðŸ”¥ðŸ”¥ðŸ”¥ PASTE YOUR FIREBASE CONFIGURATION CODE HERE ðŸ”¥ðŸ”¥ðŸ”¥
        // =================================================================
        const firebaseConfig = {
          apiKey: "AIzaSyDejfoaQpaNJ-XDpVopn1nEDl-RWseEBiQ",
          authDomain: "e-commerce-app-e1d9e.firebaseapp.com",
          databaseURL: "https://e-commerce-app-e1d9e-default-rtdb.firebaseio.com",
          projectId: "e-commerce-app-e1d9e",
          storageBucket: "e-commerce-app-e1d9e.firebasestorage.app",
          messagingSenderId: "203220920862",
          appId: "1:203220920862:web:3cfdf5bf300c119dfc5c0f",
          measurementId: "G-D43W7XSYQR"
        };
        // =================================================================

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const CURRENCY = 'à¤°à¥‚';

        let products = [], currentUser = null, userWishlist = [], userCart = [];
        
        // --- UI & ANIMATION HELPERS ---
        const showLoader = () => document.getElementById('loader').classList.add('active');
        const hideLoader = () => document.getElementById('loader').classList.remove('active');
        const showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-times-circle'}"></i> ${message}`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.animationDelay = `${entry.target.dataset.index * 0.05}s`;
                    entry.target.classList.add('animate');
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.1 });

        // --- CORE AUTH & UI SWITCHING ---
        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('store-view').style.display = 'block';
                loadUserData(user.uid);
                handleRouteChange();
            } else {
                document.getElementById('login-view').style.display = 'flex';
                document.getElementById('store-view').style.display = 'none';
                window.location.hash = '#home';
            }
        });

        const loadUserData = (uid) => {
            db.ref(`users/${uid}/cart`).on('value', snap => {
                userCart = snap.val() ? Object.values(snap.val()) : [];
                updateBadges(); if(window.location.hash === '#cart') renderCart();
            });
            db.ref(`users/${uid}/wishlist`).on('value', snap => {
                userWishlist = snap.val() ? Object.values(snap.val()) : [];
                updateBadges(); if(window.location.hash === '#wishlist') renderWishlist();
            });
        };

        // --- ROUTING ---
        const handleRouteChange = () => {
            if (!currentUser) return;
            const hash = window.location.hash || '#home';
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-link, .bottom-nav-link').forEach(l => l.classList.remove('active'));
            
            const activePage = document.getElementById(hash.substring(1) + '-page');
            if (activePage) activePage.classList.add('active');
            
            document.querySelectorAll(`[href="${hash}"]`).forEach(l => l.classList.add('active'));

            // Clear notification dots on page visit
            if (hash === '#cart') {
                localStorage.removeItem('newCartItems');
                document.getElementById('mobile-cart-link').classList.remove('has-new');
                document.getElementById('desktop-cart-link').classList.remove('has-new');
            } else if (hash === '#wishlist') {
                localStorage.removeItem('newWishlistItems');
                document.getElementById('mobile-wishlist-link').classList.remove('has-new');
                document.getElementById('desktop-wishlist-link').classList.remove('has-new');
            }

            const pageRenderFunctions = { '#wishlist': renderWishlist, '#cart': renderCart, '#orders': renderOrders, '#profile': renderProfile };
            if (pageRenderFunctions[hash]) pageRenderFunctions[hash]();
        };

        // --- PRODUCT & DATA LOGIC ---
        const fetchProducts = () => {
            renderSkeletons(8); // Show skeletons before fetching
            db.ref('products').once('value', (snapshot) => {
                products = snapshot.exists() ? Object.keys(snapshot.val()).map(key => ({ id: key, ...snapshot.val()[key] })) : [];
                renderProducts(products, 'product-grid');
            });
        };

        const renderSkeletons = (count) => {
            const grid = document.getElementById('product-grid');
            let skeletons = '';
            for (let i = 0; i < count; i++) {
                skeletons += `
                    <div class="skeleton-card">
                        <div class="skeleton-img shimmer"></div>
                        <div class="skeleton-body">
                            <div class="skeleton-text shimmer"></div>
                            <div class="skeleton-text shimmer" style="width: 60%;"></div>
                        </div>
                    </div>`;
            }
            grid.innerHTML = skeletons;
        };

        const renderProducts = (productsToRender, gridId) => {
            const grid = document.getElementById(gridId);
            grid.innerHTML = productsToRender.map((product, index) => {
                const isWishlisted = userWishlist.some(item => item.id === product.id);
                return `
                    <div class="product-card" data-id="${product.id}" data-index="${index}">
                        <img src="${product.imageUrl}" alt="${product.name}" class="product-card-img">
                        <div class="product-card-body">
                            <h3 class="product-card-title">${product.name}</h3>
                            <p class="product-card-price">${CURRENCY}${product.price.toLocaleString()}</p>
                            <div class="product-card-actions">
                                <button class="btn btn-primary add-to-cart-btn" data-id="${product.id}"><i class="fas fa-cart-plus"></i> Add</button>
                                <button class="icon-btn toggle-wishlist-btn" data-id="${product.id}"><i class="fas fa-heart ${isWishlisted ? 'fas' : 'far'}"></i></button>
                            </div>
                        </div>
                    </div>`;
            }).join('') || '<p>No products found.</p>';
            
            document.querySelectorAll(`#${gridId} .product-card`).forEach(card => observer.observe(card));
        };

        const updateBadges = () => {
            const cartCount = userCart.reduce((sum, item) => sum + item.quantity, 0);
            const wishlistCount = userWishlist.length;
            
            // Update counts
            document.getElementById('cart-badge-mobile').textContent = cartCount;
            document.getElementById('wishlist-badge-mobile').textContent = wishlistCount;
            document.getElementById('cart-badge-desktop').textContent = cartCount;
            document.getElementById('wishlist-badge-desktop').textContent = wishlistCount;

            // Show/hide numbered badges
            document.querySelectorAll('#cart-badge-mobile, #cart-badge-desktop').forEach(b => b.classList.toggle('visible', cartCount > 0));
            document.querySelectorAll('#wishlist-badge-mobile, #wishlist-badge-desktop').forEach(b => b.classList.toggle('visible', wishlistCount > 0));

            // Update notification dots
            if (localStorage.getItem('newCartItems') === 'true') {
                document.getElementById('mobile-cart-link').classList.add('has-new');
                document.getElementById('desktop-cart-link').classList.add('has-new');
            }
            if (localStorage.getItem('newWishlistItems') === 'true') {
                document.getElementById('mobile-wishlist-link').classList.add('has-new');
                document.getElementById('desktop-wishlist-link').classList.add('has-new');
            }
        };
        
        // --- CART, WISHLIST, ORDERS LOGIC ---
        const addToCart = async (productId) => {
            const product = products.find(p => p.id === productId);
            if (!product || !currentUser) return;
            const existingItem = userCart.find(item => item.id === productId);
            const newQty = (existingItem?.quantity || 0) + 1;
            await db.ref(`users/${currentUser.uid}/cart/${productId}`).set({ ...product, quantity: newQty });
            localStorage.setItem('newCartItems', 'true');
            updateBadges();
            showToast(`${product.name} added to cart!`);
        };
        
        const toggleWishlist = async (productId) => {
            const product = products.find(p => p.id === productId);
            if (!product || !currentUser) return;
            const isWishlisted = userWishlist.some(item => item.id === productId);
            const ref = db.ref(`users/${currentUser.uid}/wishlist/${productId}`);
            const btnIcon = document.querySelector(`.toggle-wishlist-btn[data-id="${productId}"] i`);
            if (isWishlisted) {
                await ref.remove();
                if(btnIcon) { btnIcon.classList.remove('fas'); btnIcon.classList.add('far'); }
                showToast(`${product.name} removed from wishlist`);
            } else {
                await ref.set(product);
                localStorage.setItem('newWishlistItems', 'true');
                updateBadges();
                if(btnIcon) { btnIcon.classList.remove('far'); btnIcon.classList.add('fas'); }
                showToast(`${product.name} added to wishlist`);
            }
        };

        const renderCart = () => {
            const container = document.getElementById('cart-items');
            const summaryContainer = document.getElementById('cart-summary');

            if (userCart.length === 0) {
                container.innerHTML = `<div class="empty-state"><i class="fas fa-shopping-cart"></i><p>Your cart is empty.</p></div>`;
                summaryContainer.innerHTML = '';
                return;
            }

            container.innerHTML = userCart.map(item => `
                <div class="cart-item">
                    <img src="${item.imageUrl}" class="cart-item-img">
                    <div class="cart-item-details">
                        <div class="cart-item-title">${item.name}</div>
                        <div class="cart-item-price">${CURRENCY}${item.price.toLocaleString()}</div>
                        <div class="quantity-control">
                            <button class="quantity-btn" data-id="${item.id}" data-change="-1">-</button>
                            <span>${item.quantity}</span>
                            <button class="quantity-btn" data-id="${item.id}" data-change="1">+</button>
                        </div>
                    </div>
                    <div class="cart-item-actions">
                        <strong>${CURRENCY}${(item.price * item.quantity).toLocaleString()}</strong>
                        <button class="remove-item-btn" data-id="${item.id}"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');

            const total = userCart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            summaryContainer.innerHTML = `
                <h3>Order Summary</h3>
                <hr style="margin: 1rem 0;">
                <div class="summary-row">
                    <span>Subtotal</span>
                    <span>${CURRENCY}${total.toLocaleString()}</span>
                </div>
                <div class="summary-row">
                    <span>Shipping</span>
                    <span>FREE</span>
                </div>
                <hr style="margin: 1rem 0;">
                <div class="summary-row" style="font-size: 1.2rem;">
                    <span><strong>Total</strong></span>
                    <span><strong>${CURRENCY}${total.toLocaleString()}</strong></span>
                </div>
                <button id="checkout-btn" class="btn btn-primary">Proceed to Checkout</button>
            `;
        };

        const renderWishlist = () => { /* ... same as before ... */ };
        const renderOrders = () => { /* ... same as before ... */ };
        const renderProfile = () => {
            if (currentUser) {
                document.getElementById('profile-email').textContent = currentUser.email;
            }
        };

        // --- MODAL RENDERING ---
        const renderProductDetailModal = (product) => {
            const modal = document.getElementById('product-detail-modal');
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close-btn">&times;</span>
                    <img src="${product.imageUrl}" style="width:100%; border-radius:12px; margin-bottom:1rem;">
                    <h2>${product.name}</h2>
                    <p style="font-size:1.5rem; font-weight:700; color:var(--primary-color);">${CURRENCY}${product.price.toLocaleString()}</p>
                    <p style="color:var(--subtle-text-color); margin:1rem 0;">${product.description}</p>
                    <button class="btn btn-primary add-to-cart-btn" data-id="${product.id}" style="width:100%;">Add to Cart</button>
                </div>`;
            modal.classList.add('active');
        };

        // --- EVENT LISTENERS ---
        window.addEventListener('hashchange', handleRouteChange);
        window.addEventListener('load', () => {
            // Inject Login & Payment Modal HTML
            document.getElementById('login-box').innerHTML = `
                <div id="login-form-container"><h2>Welcome Back!</h2><p>Please log in to start shopping.</p><form id="login-form" class="form" style="display:flex; flex-direction:column; gap:1.5rem;"><input type="email" id="login-email" class="form-control" placeholder="Email" required><input type="password" id="login-password" class="form-control" placeholder="Password" required><button type="submit" class="btn btn-primary">Login</button><p>Don't have an account? <span id="show-register" style="color:var(--primary-color); cursor:pointer; font-weight:500;">Register</span></p></form></div>
                <div id="register-form-container" style="display: none;"><h2>Create Account</h2><p>Join us and discover amazing products.</p><form id="register-form" class="form" style="display:flex; flex-direction:column; gap:1.5rem;"><input type="email" id="register-email" class="form-control" placeholder="Email" required><input type="password" id="register-password" class="form-control" placeholder="Password (min. 6 characters)" required><button type="submit" class="btn btn-primary">Register</button><p>Already have an account? <span id="show-login" style="color:var(--primary-color); cursor:pointer; font-weight:500;">Login</span></p></form></div>
            `;
            document.getElementById('payment-modal').innerHTML = `<div class="modal-content"><span class="close-btn">&times;</span><h2>Pay with </h2><p>Scan the QR code to complete your payment.</p><img id="qr-code-img" src="https://i.imgur.com/lb8Fmtv.jpeg" alt="eSewa QR Code"><p id="payment-total" style="font-size: 1.5rem; font-weight: 350; margin-bottom: 1rem;"></p><form id="payment-confirmation-form" class="form" style="display:flex; flex-direction:column; gap:1rem;"><input type="text" id="transaction-id" class="form-control" placeholder="Enter eSewa Transaction ID" required><button type="submit" class="btn btn-primary" style="width: 80%;">Confirm Payment</button></form></div>`;

            // Attach listeners
            document.getElementById('show-register').onclick = () => { document.getElementById('login-form-container').style.display = 'none'; document.getElementById('register-form-container').style.display = 'block'; };
            document.getElementById('show-login').onclick = () => { document.getElementById('login-form-container').style.display = 'block'; document.getElementById('register-form-container').style.display = 'none'; };
            document.getElementById('login-form').onsubmit = (e) => { e.preventDefault(); showLoader(); auth.signInWithEmailAndPassword(e.target['login-email'].value, e.target['login-password'].value).then(() => showToast('Login successful!')).catch(err => showToast(err.message, 'error')).finally(hideLoader); };
            document.getElementById('register-form').onsubmit = (e) => { e.preventDefault(); showLoader(); auth.createUserWithEmailAndPassword(e.target['register-email'].value, e.target['register-password'].value).then(() => showToast('Registration successful!')).catch(err => showToast(err.message, 'error')).finally(hideLoader); };
            document.getElementById('profile-logout-btn').onclick = (e) => { e.preventDefault(); auth.signOut().then(() => showToast('You have been logged out.')); };
            
            fetchProducts();
        });
        
        // Search Overlay Logic
        const searchOverlay = document.getElementById('search-overlay');
        document.getElementById('open-search').onclick = (e) => { e.preventDefault(); searchOverlay.classList.add('active'); document.getElementById('search-input').focus(); };
        document.getElementById('close-search').onclick = () => searchOverlay.classList.remove('active');
        document.getElementById('search-input').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = products.filter(p => p.name.toLowerCase().includes(searchTerm));
            renderProducts(filtered, 'search-results-grid');
        });

        // Main Click Handler
        document.body.addEventListener('click', async e => {
            const productCard = e.target.closest('.product-card');
            const addToCartBtn = e.target.closest('.add-to-cart-btn');
            const toggleWishlistBtn = e.target.closest('.toggle-wishlist-btn');
            const orderItem = e.target.closest('.order-item');
            const closeModalBtn = e.target.closest('.close-btn');
            const quantityBtn = e.target.closest('.quantity-btn');
            const removeItemBtn = e.target.closest('.remove-item-btn');
            const checkoutBtn = e.target.closest('#checkout-btn');

            if (addToCartBtn) {
                e.stopPropagation();
                addToCart(addToCartBtn.dataset.id);
            } else if (toggleWishlistBtn) {
                e.stopPropagation();
                toggleWishlist(toggleWishlistBtn.dataset.id);
            } else if (productCard) {
                const product = products.find(p => p.id === productCard.dataset.id);
                if (product) renderProductDetailModal(product);
            } else if (orderItem) {
                const detailsContainer = orderItem.querySelector('.order-item-details');
                if (orderItem.classList.toggle('open')) {
                    const orderId = orderItem.dataset.orderId;
                    const orderSnapshot = await db.ref(`orders/${orderId}`).once('value');
                    const order = orderSnapshot.val();
                    detailsContainer.innerHTML = order.items.map(item => `<p>${item.name} (x${item.quantity})</p>`).join('');
                }
            } else if (closeModalBtn) {
                closeModalBtn.closest('.modal').classList.remove('active');
            } else if (quantityBtn) {
                const { id, change } = quantityBtn.dataset;
                const item = userCart.find(i => i.id === id);
                const newQuantity = item.quantity + parseInt(change);
                if (newQuantity >= 1) db.ref(`users/${currentUser.uid}/cart/${id}`).update({ quantity: newQuantity });
            } else if (removeItemBtn) {
                db.ref(`users/${currentUser.uid}/cart/${removeItemBtn.dataset.id}`).remove();
            } else if (checkoutBtn) {
                const total = userCart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                document.getElementById('payment-total').textContent = `Total: ${CURRENCY}${total.toLocaleString()}`;
                document.getElementById('payment-modal').classList.add('active');
            }
        });

    </script>
</body>
</html>